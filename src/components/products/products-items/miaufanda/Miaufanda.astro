---
import type { Product } from '../../../../types/product';
import Guides from '@/components/guides/Guides.astro';

interface Props {
	product: Product;
}

const { product } = Astro.props;

const defaultVariant = product.variants[0];
const defaultSize = defaultVariant.sizes[0];

const formatCurrency = (value: number) => {
	return new Intl.NumberFormat('es-ES', {
		style: 'currency',
		currency: product.currency
	}).format(value);
};
---

<div
	class="product-detail miaufanda-detail"
	data-product-detail
	data-product-id={String(product.id)}
	data-product-name={product.name}
	data-product-currency={product.currency}
>
	<div class="product-detail-inner">
		<div class="product-image-area">
			<div class="image-area-background" aria-hidden="true"></div>
			<div
				class="product-image-wrapper"
				data-image-target
				role="img"
				aria-label={product.name}
				style={`background-image: url('${defaultVariant.images[0]}')`}>
			</div>
		</div>

		<div class="product-info">
			<div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
				<h2 class="product-name">{product.name}</h2>
				<Guides />
			</div>			
			<p class="product-description--full">{product.description}</p>

			{product.tags && (
				<div class="product-collections">
					{product.tags.map((tag: unknown) => (
						<span class="collection-tag">{tag}</span>
					))}
				</div>
			)}

			<div class="product-attributes">
				<!-- Selector de Color (Visual/Estático) -->
				<details class="attribute-section" open>
					<summary class="attribute-summary">
						<span class="attribute-label">Colores Disponibles</span>
						<span class="attribute-selected-value" data-selected-color>{defaultVariant.color}</span>
					</summary>
					<div class="attribute-content">
						<div class="color-options">
							{product.variants.map((variant: { color: string | null | undefined; images: (string | null | undefined)[]; }) => (
								<button
									type="button"
									class:list={['color-button', { selected: variant.color === defaultVariant.color }]}
									title={variant.color}
									data-color-button
									data-color={variant.color}
									data-image={variant.images[0]}
								>
									<img
										src={`/images/colors/${String(variant.color).toLowerCase()}.webp`}
										alt={variant.color}
										class="color-image"
										loading="lazy"
										decoding="async" />
									{variant.color === defaultVariant.color && <i class="pi pi-check color-check"></i>}
								</button>
							))}
						</div>
					</div>
				</details>

				<!-- Listado de Tallas y Precios -->
				<details class="attribute-section" open>
					<summary class="attribute-summary">
						<span class="attribute-label">Tallas y Medidas</span>
						<span class="attribute-selected-value" data-selected-size>{defaultSize.size}</span>
						<span class="attribute-selected-price" data-selected-price>{formatCurrency(defaultSize.price)}</span>
					</summary>
					<div class="attribute-content">
						<div class="size-options">
							{defaultVariant.sizes.map((size: { size: unknown; price: number; sku?: string; }) => (
								<button
									type="button"
									class:list={['size-button', { selected: size.size === defaultSize.size }]}
									data-size-button
									data-size={String(size.size)}
									data-price={String(size.price)}
									data-sku={size.sku ?? ''}
								>
									<span class="size-name">{size.size}</span>
									<span class="size-price">{formatCurrency(size.price)}</span>
								</button>
							))}
						</div>
					</div>
				</details>
			</div>

			<div class="product-footer">
				<span class="price" data-current-price>{formatCurrency(defaultSize.price)}</span>
				<div class="product-actions">
					<button type="button" class="btn btn-primary btn-cart" data-add-to-cart>
						Añadir al carrito
					</button>

<script type="module">
	if (!window.__productDetailInit) {
		window.__productDetailInit = true;

		const preloadImage = (src) => {
			if (!src) return;
			const img = new Image();
			img.decoding = 'async';
			img.loading = 'eager';
			img.src = src;
		};

		const formatCurrency = (value, currency = 'EUR') => {
			return new Intl.NumberFormat('es-ES', {
				style: 'currency',
				currency
			}).format(value);
		};

		const updateSelectedPrice = (detail, priceValue) => {
			const priceLabel = detail.querySelector('[data-selected-price]');
			const currentPrice = detail.querySelector('[data-current-price]');
			if (priceLabel) priceLabel.textContent = priceValue;
			if (currentPrice) currentPrice.textContent = priceValue;
		};

		document.addEventListener('click', (event) => {
			const colorButton = event.target?.closest?.('[data-color-button]');
			if (colorButton) {
				const detail = colorButton.closest('[data-product-detail]');
				if (!detail) return;

				const image = detail.querySelector('[data-image-target]');
				const selectedColorLabel = detail.querySelector('[data-selected-color]');
				const buttons = detail.querySelectorAll('[data-color-button]');

				const color = colorButton.getAttribute('data-color');
				const nextImage = colorButton.getAttribute('data-image');
				if (selectedColorLabel && color) selectedColorLabel.textContent = color;

				buttons.forEach((b) => b.classList.remove('selected'));
				colorButton.classList.add('selected');

				if (image && nextImage) {
					image.style.backgroundImage = `url('${nextImage}')`;
				}
				return;
			}

			const sizeButton = event.target?.closest?.('[data-size-button]');
			if (sizeButton) {
				const detail = sizeButton.closest('[data-product-detail]');
				if (!detail) return;

				const selectedSizeLabel = detail.querySelector('[data-selected-size]');
				const sizeButtons = detail.querySelectorAll('[data-size-button]');
				const size = sizeButton.getAttribute('data-size');
				const price = sizeButton.getAttribute('data-price');

				sizeButtons.forEach((b) => b.classList.remove('selected'));
				sizeButton.classList.add('selected');

				if (selectedSizeLabel && size) selectedSizeLabel.textContent = size;
				if (price) {
					const currency = detail.getAttribute('data-product-currency') || 'EUR';
					updateSelectedPrice(detail, formatCurrency(Number(price), currency));
				}
			}
		});

		document.querySelectorAll('[data-color-button][data-image]').forEach((button) => {
			const src = button.getAttribute('data-image');
			if (src) preloadImage(src);
		});
	}
</script>

<style>

	.product-detail {
		position: relative;
		background: transparent;
		width: 100% !important;
		box-shadow: 0 20px 50px rgba(31, 26, 22, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.4);
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.product-detail-inner {
		display: flex;
		flex-direction: column;
		align-items: center;
		z-index: 10;
	}

	.product-image-area {
		position: relative;
		width: 100%;
		border-radius: 20px;
		padding: clamp(1rem, 3vw, 1.5rem);
		background: linear-gradient(135deg, rgba(255, 237, 225, 0.9), rgba(255, 249, 244, 0.6));
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
	}

	.image-area-background {
		position: absolute;
		inset: 0;
		background: url('/images/hero/product-background.webp') center/cover no-repeat;
		opacity: 0.35;
		z-index: 0;
	}

	.product-image-wrapper {
		position: relative;
		width: 100%;
		overflow: hidden;
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
		transition: background-image 0.5s ease-in-out;
		z-index: 1;
		min-height: clamp(240px, 60vw, 420px);
	}

	.product-info {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		width: 100%;
		padding: clamp(2rem, 3vw, 3rem);
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
	}

	.product-info::before {
    content: "";
    position: absolute;
    inset: 0;
    background: url('/images/hero/miaufanda-product-background.webp') center/cover no-repeat;
	background-position-x: 40rem;
    opacity: 0.1;
	width: 100%;
	height: 100%;
    z-index: -1;
    pointer-events: none;
  }

	.product-name {
		font-size: clamp(2rem, 5vw, 3.5rem);
		font-family: var(--font-product);
		color: var(--color-ink);
		margin: 0;
	}

	.product-description--full {
		font-size: 1.2rem;
		line-height: 1.7;
		color: #4b5563;
	}

	.product-collections {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.collection-tag {
		padding: 0.4rem 1rem;
		border-radius: 50px;
		border: 1px solid rgba(197, 116, 74, 0.3);
		color: var(--color-rust);
		font-size: 0.85rem;
		text-transform: capitalize;
	}

	.attribute-section {
		margin-bottom: 1rem;
		border-radius: 14px;
		border: 1px solid rgba(231, 216, 208, 0.8);
		background: white;
		padding: 0.25rem 0.75rem;
	}

	.attribute-summary {
		list-style: none;
		display: flex;
		align-items: center;
		justify-content: flex-start;
		gap: 0.75rem;
		cursor: pointer;
		padding: 0.75rem 0.25rem;
	}

	.attribute-summary::-webkit-details-marker {
		display: none;
	}

	.attribute-summary::after {
		content: "▾";
		font-size: 0.9rem;
		color: var(--color-gray-500);
		transition: transform 0.2s ease;
	}

	details[open] > .attribute-summary::after {
		transform: rotate(180deg);
	}

	.attribute-content {
		padding: 0 0.25rem 0.75rem;
	}

	.attribute-label {
		font-weight: bold;
		text-transform: uppercase;
		font-size: 0.8rem;
		letter-spacing: 1px;
		color: var(--color-gray-800);
	}

	.attribute-selected-value {
		margin-left: 0.5rem;
		color: var(--color-gray-500);
		font-size: 0.9rem;
	}

	.attribute-selected-price {
		margin-left: 0.5rem;
		color: var(--color-rust);
		font-size: 0.9rem;
		font-weight: 600;
	}

	.color-options {
		display: flex;
		gap: 0.75rem;
		margin-top: 0.5rem;
		flex-wrap: wrap;
	}

	.color-button {
		width: 44px;
		height: 44px;
		border-radius: 50%;
		border: 2px solid transparent;
		overflow: hidden;
		padding: 2px;
		transition: var(--transition-fast);
        cursor: pointer;
	}

	.color-button.selected {
		border-color: var(--color-ink);
	}

	.color-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		border-radius: 50%;
	}

	.size-options {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.size-button {
		border: 1px solid #e5e7eb;
		padding: 0.75rem;
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
		background: white;
		cursor: pointer;
		text-align: center;
	}

	.size-button.selected {
		border-color: var(--color-ink);
		box-shadow: 0 0 0 2px rgba(153, 126, 100, 0.2);
	}

	.size-price {
		font-size: 0.8rem;
		font-weight: bold;
		color: var(--color-rust);
	}

	.product-footer {
		border-top: 1px solid #eee;
		padding-top: 1.5rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.product-actions {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem;
		align-items: center;
	}

	.price {
		font-size: 2rem;
		font-weight: 800;
	}

	.btn-primary {
		background: var(--color-rust);
		color: white;
		padding: 0.8rem 1.5rem;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 600;
		transition: filter 0.2s;
		cursor: pointer;

	}

	.btn-primary:hover {
		filter: brightness(1.1);
	}

	.product-card-note {
		font-size: 0.85rem;
		color: var(--color-gray-500);
		font-style: italic;
	}

	@media (max-width: 768px) {
		.product-detail {
			padding: 1.25rem;
		}

		.product-collections,
		.color-options,
		.size-options {
			gap: 0.5rem;
		}

		.size-options {
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
		}

		.attribute-section {
			margin-bottom: 0.75rem;
		}

		.attribute-summary::after {
			content: "+";
		}

		details[open] > .attribute-summary::after {
			content: "–";
			transform: none;
		}

		.attribute-label {
			font-size: 0.6rem;
		}

		.product-image-area {
			position: relative;
			top: 0;
		}
	}

	@media (min-width: 769px) {
		.product-detail-inner {
			flex-direction: row;
			align-items: stretch;
			height: 100dvh !important;
		}

		.product-image-area,
		.product-info {
			width: 50%;
		}

		.product-image-area {
			display: flex;
			align-self: stretch;
		}

		.product-image-wrapper {
			height: 100%;
			position: sticky;
			top: 2rem;
			min-height: 0;
		}

		.attribute-summary::after {
			display: none;
		}

		.attribute-section {
			border: none;
			background: transparent;
			padding: 0;
		}

		.attribute-content {
			padding: 0;
		}
	}
</style>
